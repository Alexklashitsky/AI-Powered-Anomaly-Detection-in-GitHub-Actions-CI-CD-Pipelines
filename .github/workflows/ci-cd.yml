name: Flask CI/CD Pipeline

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests
        run: |
          pytest --cov=. --cov-report=xml --cov-report=term
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: coverage.xml

  deploy:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Build and push Docker image to Azure Container Registry
        run: |
          # Replace with your ACR name
          ACR_NAME="your-acr-name"
          IMAGE_NAME="flask-app"
          IMAGE_TAG="${{ github.sha }}"
          
          # Login to ACR
          az acr login --name $ACR_NAME
          
          # Build and push image
          docker build -t $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG .
          docker push $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG
      
      - name: Deploy to Azure App Service
        run: |
          # Replace with your App Service name and resource group
          APP_NAME="your-app-service-name"
          RESOURCE_GROUP="your-resource-group"
          ACR_NAME="your-acr-name"
          IMAGE_NAME="flask-app"
          IMAGE_TAG="${{ github.sha }}"
          
          # Deploy container to App Service
          az webapp config container set \
            --name $APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --docker-custom-image-name $ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG \
            --docker-registry-server-url https://$ACR_NAME.azurecr.io
          
          # Restart the app service
          az webapp restart --name $APP_NAME --resource-group $RESOURCE_GROUP
      
      - name: Logout from Azure
        if: always()
        run: |
          az logout
